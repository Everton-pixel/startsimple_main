<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StartSimple - Comunidade</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; margin: 0; overflow-x: hidden; }
    .brand-gradient { background: linear-gradient(to right bottom, #a3557c, #0e3bc2); }
    
    /* SIDEBAR */
    .sidebar { width: 80px; height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.05); }
    .nav-item { width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; margin: 15px 0; border-radius: 12px; color: rgba(255, 255, 255, 0.7); cursor: pointer; transition: all 0.3s ease; font-size: 1.2rem; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.2); color: white; transform: translateX(3px); }
    .nav-item.active { background: white; color: #0e3bc2; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    /* MAIN */
    .main-content { margin-left: 80px; padding: 30px 50px; min-height: 100vh; }
    
    /* FILTERS */
    .filter-navbar { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 10px; margin-top: 20px; margin-bottom: 30px; scrollbar-width: none; }
    .filter-btn { padding: 10px 24px; border-radius: 50px; font-size: 0.95rem; font-weight: 500; cursor: pointer; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: all 0.3s ease; white-space: nowrap; }
    .filter-btn:hover { border-color: #a3557c; color: #a3557c; }
    .filter-btn.active { background: linear-gradient(to right bottom, #a3557c, #0e3bc2); color: white; border: none; box-shadow: 0 4px 12px rgba(14, 59, 194, 0.3); transform: translateY(-1px); }

    /* CARDS */
    .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
    .post-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); transition: transform 0.3s ease; border: 1px solid #f1f5f9; display: flex; flex-direction: column; }
    /* .post-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); } */ /* Removido hover agressivo para facilitar clique nos botoes */
    
    .card-img { height: 160px; background-color: #cbd5e1; position: relative; background-size: cover; background-position: center; }
    .card-tag { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: #0e3bc2; text-transform: uppercase; }
    .card-body { padding: 20px; display: flex; flex-direction: column; flex: 1; }
    .card-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 8px; }
    .card-desc { font-size: 0.9rem; color: #64748b; line-height: 1.5; margin-bottom: 20px; }
    .card-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; padding-top: 15px; }
    
    /* AREA DE COMENTARIOS */
    .comments-section { display: none; background: #f8fafc; padding: 15px; border-top: 1px solid #e2e8f0; }
    .comment-item { font-size: 0.85rem; margin-bottom: 10px; padding: 8px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
    
    /* MODAL */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 30px; position: relative; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>

  <aside class="sidebar brand-gradient">
    <div style="margin-bottom: 40px; color: white; font-size: 1.2rem; font-weight: bold;"><i class="fa-solid fa-rocket"></i></div>
    <div class="nav-item active" onclick="window.location.href='tela-pos-login.html'"><i class="fa-solid fa-house"></i></div>
    <div class="nav-item"onclick="window.location.href='perfil.html'" ><i class="fa-solid fa-user"></i></div>
    <div class="nav-item"><i class="fa-solid fa-heart"></i></div>
    <div class="nav-item"><i class="fa-solid fa-bell"></i></div>
  </aside>

  <main class="main-content">
    <div class="flex justify-between items-center mb-2">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">Comunidade</h1>
            <p class="text-slate-500 mt-1">Explore projetos, vagas e discussões.</p>
        </div>
        <button onclick="abrirModal()" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 shadow-sm transition flex items-center gap-2">
            <i class="fa-solid fa-plus text-purple-600"></i> Novo Post
        </button>
    </div>

    <nav class="filter-navbar">
      <button class="filter-btn active" onclick="filtrar('todos', this)">Todos</button>
      <button class="filter-btn" onclick="filtrar('Tecnologia', this)">Tecnologia</button>
      <button class="filter-btn" onclick="filtrar('Culinária', this)">Culinária</button>
      <button class="filter-btn" onclick="filtrar('Entretenimento', this)">Entretenimento</button>
      <button class="filter-btn" onclick="filtrar('Comércio', this)">Comércio</button>
      <button class="filter-btn" onclick="filtrar('Arte', this)">Arte</button>
      <button class="filter-btn" onclick="filtrar('Serviços', this)">Serviços</button>
    </nav>

    <div class="content-grid" id="feedGrid">
        <p class="text-slate-400 col-span-full text-center py-10">Carregando posts...</p>
    </div>
  </main>

  <div class="modal-overlay" id="modalPost">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-slate-800">Criar Novo Post</h2>
            <button onclick="fecharModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>

        <form id="formPost" onsubmit="criarPost(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                <input type="text" id="titulo" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
                <select id="categoria" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                    <option value="Tecnologia">Tecnologia</option>
                    <option value="Culinária">Culinária</option>
                    <option value="Entretenimento">Entretenimento</option>
                    <option value="Comércio">Comércio</option>
                    <option value="Arte">Arte</option>
                    <option value="Serviços">Serviços</option>
                    <option value="Educação">Educação</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-700 mb-1">URL da Imagem (Opcional)</label>
                <input type="text" id="imagem" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
                <textarea id="descricao" rows="3" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
            </div>

            <button type="submit" class="w-full py-3 rounded-lg text-white font-bold shadow-lg bg-gradient-to-r from-purple-600 to-blue-600 hover:opacity-90 transition">
                Publicar
            </button>
        </form>
    </div>
  </div>

  <script>
    const apiUrl = 'http://localhost:3000';

    // 1. Abrir e Fechar Modal
    function abrirModal() { document.getElementById('modalPost').style.display = 'flex'; }
    function fecharModal() { document.getElementById('modalPost').style.display = 'none'; }

    // 2. Carregar Posts ao iniciar
    window.onload = carregarPosts;

    async function carregarPosts() {
        try {
            const res = await fetch(`${apiUrl}/posts`);
            const posts = await res.json();
            const grid = document.getElementById('feedGrid');
            grid.innerHTML = ''; 

            if(posts.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-slate-400">Nenhum post encontrado. Seja o primeiro!</p>';
                return;
            }

            posts.forEach(post => {
                const imagem = post.imagem_url || 'https://via.placeholder.com/400x200?text=StartSimple';
                
                const cardHTML = `
                <article class="post-card" data-category="${post.categoria}">
                    <div class="card-img" style="background-image: url('${imagem}')">
                        <span class="card-tag">${post.categoria}</span>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${post.titulo}</h3>
                        <p class="card-desc">${post.descricao}</p>
                        <div class="card-footer">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500">
                                    ${post.autor ? post.autor.charAt(0) : 'U'}
                                </div>
                                <span class="text-xs font-semibold text-slate-600">${post.autor || 'Usuário'}</span>
                            </div>
                            <div class="flex gap-4 text-sm text-slate-400">
                                <button onclick="darLike(${post.id})" class="flex items-center gap-1 hover:text-red-500 transition">
                                    <i class="fa-regular fa-heart"></i>
                                    <span id="likes-${post.id}">${post.curtidas || 0}</span>
                                </button>
                                <button onclick="toggleComentarios(${post.id})" class="flex items-center gap-1 hover:text-blue-500 transition">
                                    <i class="fa-regular fa-comment"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="comments-section" id="comments-${post.id}">
                        <div id="lista-comentarios-${post.id}" class="mb-3 max-h-40 overflow-y-auto">
                            </div>
                        <div class="flex gap-2">
                            <input type="text" id="input-comentario-${post.id}" placeholder="Escreva um comentário..." 
                                   class="w-full text-sm px-3 py-2 border rounded-lg outline-none focus:border-blue-500">
                            <button onclick="enviarComentario(${post.id})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </article>
                `;
                grid.innerHTML += cardHTML;
            });
        } catch (error) {
            console.error(error);
        }
    }

    // 3. Criar Novo Post
    async function criarPost(e) {
        e.preventDefault();
        const titulo = document.getElementById('titulo').value;
        const categoria = document.getElementById('categoria').value;
        const imagem = document.getElementById('imagem').value;
        const descricao = document.getElementById('descricao').value;
        const autor = "Usuário Teste"; // Você pode pegar do localStorage se tiver login salvo

        try {
            const res = await fetch(`${apiUrl}/posts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo, descricao, categoria, imagem_url: imagem, autor })
            });

            if(res.ok) {
                fecharModal();
                document.getElementById('formPost').reset();
                carregarPosts(); 
            } else {
                alert('Erro ao criar post.');
            }
        } catch (error) {
            alert('Erro de conexão.');
        }
    }

    // 4. Lógica de Likes
    async function darLike(postId) {
        try {
            const res = await fetch(`${apiUrl}/posts/${postId}/like`, { method: 'POST' });
            if(res.ok) {
                const data = await res.json();
                // Atualiza o número na tela sem recarregar tudo
                document.getElementById(`likes-${postId}`).innerText = data.curtidas;
                
                // Animação visualzinha
                const btn = document.getElementById(`likes-${postId}`).parentElement;
                btn.classList.add('text-red-500');
                btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
            }
        } catch (error) { console.error(error); }
    }

    // 5. Lógica de Comentários
    async function toggleComentarios(postId) {
        const div = document.getElementById(`comments-${postId}`);
        
        // Se estiver fechado, abre e carrega os comentários
        if (div.style.display === 'none' || div.style.display === '') {
            div.style.display = 'block';
            
            // Carregar do servidor
            const res = await fetch(`${apiUrl}/posts/${postId}/comments`);
            const comentarios = await res.json();
            
            const listaDiv = document.getElementById(`lista-comentarios-${postId}`);
            listaDiv.innerHTML = '';
            
            if(comentarios.length === 0) {
                listaDiv.innerHTML = '<p class="text-xs text-slate-400 italic">Seja o primeiro a comentar!</p>';
            } else {
                comentarios.forEach(c => {
                    listaDiv.innerHTML += `
                        <div class="comment-item">
                            <span class="font-bold text-xs text-blue-600 block">${c.autor || 'Anônimo'}</span>
                            <span class="text-slate-700">${c.texto}</span>
                        </div>
                    `;
                });
            }

        } else {
            // Se estiver aberto, fecha
            div.style.display = 'none';
        }
    }

    async function enviarComentario(postId) {
        const input = document.getElementById(`input-comentario-${postId}`);
        const texto = input.value;
        if(!texto) return;

        try {
            const res = await fetch(`${apiUrl}/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto, autor: "Eu" }) // "Eu" temporário até integrarmos login real
            });

            if(res.ok) {
                input.value = '';
                // Recarrega a lista de comentários forçando o toggle
                document.getElementById(`comments-${postId}`).style.display = 'none';
                toggleComentarios(postId);
            }
        } catch (error) { console.error(error); }
    }

    // 6. Filtros
    function filtrar(categoria, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const cards = document.querySelectorAll('.post-card');
        cards.forEach(card => {
            if(categoria === 'todos' || card.getAttribute('data-category') === categoria) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    }
  </script>

</body>
</html>